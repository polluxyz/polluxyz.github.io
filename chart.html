<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>chart</title>
  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/stock/modules/drag-panes.js"></script>
  <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/stock/modules/accessibility.js"></script>
</head>

<body>
  <div id="container" style="height: 600px; min-width: 310px"></div>

  <script>
    (async () => {

      const row = []
      const data = await fetch(
        "stock_data/total_date/1101_台泥.json"
      )
      .then(response => response.json());

      console.log(data)

      const rowData = data.data;
      // console.log(rowData[0][0].trim())

      const parseDate = (dateStr) => {
        const [year, month, day] = dateStr.trim().split('/').map(Number);
        return Date.UTC(year + 1911, month - 1, day); // 民國年轉西元年
      };

      // split the data set into ohlc and volume
      const ohlc = [],
        volume = [],
        dataLength = rowData.length,
        // set the allowed units for data grouping
        groupingUnits = [[
          'week',                         // unit name
          [1]                             // allowed multiples
        ], [
          'month',
          [1, 2, 3, 4, 6]
        ]];

      for (let i = 0; i < dataLength; i += 1) {
        const date = parseDate(rowData[i][0]);
        // console.log(rowData[i])
        ohlc.push([
          date, // the date
          parseFloat(rowData[i][3]), // open
          parseFloat(rowData[i][4]), // high
          parseFloat(rowData[i][5]), // low
          parseFloat(rowData[i][6]) // close
        ]);

        volume.push([
          date, // the date
          parseInt(rowData[i][1].replace(/,/g, '')) // the volume
        ]);
      }

      // 將資料按照日期排序
      ohlc.sort((a, b) => a[0] - b[0]);
      volume.sort((a, b) => a[0] - b[0]);

      // create the chart
      Highcharts.stockChart('container', {

        rangeSelector: {
          selected: 4
        },

        title: {
          text: 'AAPL Historical'
        },

        yAxis: [{
          labels: {
            align: 'right',
            x: -3
          },
          title: {
            text: 'OHLC'
          },
          height: '60%',
          lineWidth: 2,
          resize: {
            enabled: true
          }
        }, {
          labels: {
            align: 'right',
            x: -3
          },
          title: {
            text: 'Volume'
          },
          top: '65%',
          height: '35%',
          offset: 0,
          lineWidth: 2
        }],

        tooltip: {
          split: true
        },

        series: [{
          type: 'candlestick',
          name: '台泥',
          data: ohlc,
          dataGrouping: {
            units: groupingUnits
          },
          turboThreshold: 100000
        }, {
          type: 'column',
          name: 'Volume',
          data: volume,
          yAxis: 1,
          dataGrouping: {
            units: groupingUnits
          },
          turboThreshold: 100000
        }]
      });
    })();
  </script>
</body>

</html>